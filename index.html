<!doctype html>

<html>
    <head>
    <meta charset="UTF-8">
    <script type='text/javascript' src='./node_modules/paper/dist/paper-full.min.js'></script>
    <script type='text/javascript' src='./node_modules/papaparse/papaparse.min.js'></script>

    <style>
        html, body {
            margin: 0;
            overflow: hidden;
            height: 100%
        }

        canvas[resize] {
            width: 100%;
            height: 100%
        }

        .btn {
            margin: 10px;
        }
    </style>

    <script type='text/paperscript' canvas='thecanvas'>

        var data;
        var width = document.getElementById('thecanvas').width
        var height = document.getElementById('thecanvas').height
        var padding_h = 150
        var animation_duration = 50;
        var last_click_frame = 0;
        var cur_frame = 0;
        var path;

        var colors = ['#ECD078', '#D95b43', '#C02942', '#542437', '#53777A'];
        var prev_color;
        var new_color;

        var line_y = 500;
        var line_w = width - padding_h;

        var node_distances = [];
        var datatype = 'history'

        var gen_line_points = function(){
           var points = [];
           var space_between_points = parseInt(line_w / data.length)
           
           for (i in data)  {
               points.push(new Point(padding_h/2 + node_distances[i] * 20, line_y))
           }
           
           return points;
        }

        var gen_circle_points = function(){
            var points = []
            var radius = 200;
            var anglestep = 360/data.length;

            for (i in data) points.push(
                new Point(
                    width/2 + Math.cos(2 * Math.PI * i / data.length)*radius, 
                    height/2 + Math.sin(2 * Math.PI * i / data.length)*radius 
                    ))

            return points
        }

        var draw_circle = function(){
            last_click_frame = cur_frame;
            prev_color = path.strokeColor;
            new_color = colors[parseInt(Math.random()*colors.length)]
        }


        var draw_line = function(){
            last_click_frame = cur_frame;            
        }

        var draw_spiral = function(){
            last_click_frame = cur_frame;            
        }
        
        var draw = function(){

            prev_color = colors[parseInt(Math.random()*colors.length)];
            new_color = colors[parseInt(Math.random()*colors.length)];

            path = new Path();
            path.strokeColor = prev_color 
            path.strokeWidth = 20;
            path.strokeCap = 'round';
            
            if (datatype == 'history'){
                var maxdistance = data[data.length - 1][0] - data[0][0]
                for (var i = 0; i < data.length; i++){
                    node_distances.push((data[i][0] - data[0][0]))
                }
            }

            points = gen_circle_points()
            
            for (i in points) {
                path.add(points[i]);
                
                text = new PointText(new Point(points[i].x, points[i].y - 20));
                text.justification = 'center';
                text.fillColor = 'black';
                text.content = data[i][0];
                
                text = new PointText(new Point(points[i].x, points[i].y + 200));
                text.justification = 'center';
                text.fillColor = 'black';
                //text.content = data[i][1];
                text.rotation = 45
            }

            path.smooth()
        }

        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        var easeColor = function(prev_color, new_color, i){
            prev_rgb = hexToRgb(prev_color)
            new_rgb = hexToRgb(new_color)
            
            var x_r = (new_rgb.r - prev_rgb.r) * i / animation_duration;
            var x_g = (new_rgb.g - prev_rgb.g) * i / animation_duration;
            var x_b = (new_rgb.b - prev_rgb.b) * i / animation_duration;

            return rgbToHex(prev_rgb.r + x_r, prev_rgb.g + x_g, prev_rgb.b + x_b)
        }

        function onFrame(event) {
            cur_frame += 1;
            if (cur_frame - last_click_frame > animation_duration) return;
            path.strokeColor = easeColor(prev_color, new_color, cur_frame - last_click_frame)
            //for (var i = 0; i <= data.length -1; i++) {
            //    var segment = path.segments[i];

            //    var sinus = Math.sin(event.time + i);
                // Change the y position of the segment point:
            //    segment.point.y = sinus * height/10 + height/4 + 100;
            //}
            //path.smooth();

        }

        document.getElementById('circle_btn').onclick = draw_circle
        document.getElementById('line_btn').onclick = draw_line
        document.getElementById('spiral_btn').onclick = draw_spiral

        Papa.parse('data/history.csv', {
            download: true,
            dynamicTyping: true,
            complete: function(results) {
                 
                data = results.data.splice(1, results.data.length);
                draw()
            }
        })

    </script>
    </head>

    <body>
        <button class = 'btn' id='circle_btn'> circular </button>
        <button class = 'btn' id='line_btn'> linear </button>
        <button class = 'btn' id='spiral_btn'> spiral </button>
        <canvas id='thecanvas' resize></canvas>
    </body>
</html>
